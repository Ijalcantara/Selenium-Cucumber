name: Run Selenium-Cucumber Tests with Grafana Loki (v12)

on:
  repository_dispatch:
    types: [ run-tests ]
  workflow_dispatch:

jobs:
  tests:
    name: Selenium Cucumber + Allure + Grafana Loki
    runs-on: ubuntu-latest

    env:
      PROJECT_NAME: selenium-cucumber
      ENV: ${{ github.event.client_payload.env || vars.ENV || 'staging' }}
      HEADLESS: "true"

    steps:
      # ---------------- Checkout & Setup ----------------
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1

      - name: Set up Node.js (for Allure CLI)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Allure CLI
        run: npm install -g allure-commandline@2

      # ---------------- Run Selenium + Cucumber Tests ----------------
      - name: Run Selenium Cucumber Tests
        env:
          HEADLESS: ${{ env.HEADLESS }}
        run: |
          echo "üéØ Running tests (headless=${HEADLESS})..."
          mvn -B clean test -Dheadless="${HEADLESS}"

      # ---------------- Upload Reports ----------------
      - name: Upload raw reports
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: raw-reports
          path: |
            **/target/surefire-reports/**
            **/target/cucumber-reports/**
            **/target/allure-results/**

      # ---------------- Allure HTML Report ----------------
      - name: Generate Allure HTML Report
        if: ${{ always() }}
        run: |
          if [ -d "target/allure-results" ]; then
            allure generate target/allure-results --clean -o allure-report
            echo "‚úÖ Allure HTML report generated."
          else
            echo "‚ö†Ô∏è No Allure results found; skipping HTML report."
          fi

      - name: Upload Allure HTML Report
        if: ${{ always() && hashFiles('allure-report/index.html') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: allure-html
          path: allure-report

      # ---------------- Allure Single File ----------------
      - name: Generate Single File Allure Report
        if: ${{ always() }}
        run: |
          if [ -d "target/allure-results" ]; then
            allure generate target/allure-results --single-file --clean -o target/allure-single
          else
            echo "‚ö†Ô∏è Skipping single-file Allure generation."
          fi

      - name: Upload Allure Single File Report
        if: ${{ always() && hashFiles('target/allure-single/index.html') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: allure-single-file
          path: target/allure-single

      # ---------------- Push Metrics to Grafana Loki ----------------
      - name: Push Test Metrics to Grafana Loki
        if: ${{ always() }}
        env:
          LOKI_URL: ${{ secrets.GRAFANA_LOKI_URL }}
          LOKI_USER: ${{ secrets.GRAFANA_LOKI_USER }}
          LOKI_TOKEN: ${{ secrets.GRAFANA_LOKI_TOKEN }}
          PROJECT_NAME: ${{ env.PROJECT_NAME }}
          ENV: ${{ env.ENV }}
        run: |
          set -euo pipefail

          echo "üß† Checking Grafana Loki credentials..."
          for v in LOKI_URL LOKI_USER LOKI_TOKEN; do
            if [ -z "${!v:-}" ]; then
              echo "‚ùå Missing required env: $v"
              exit 1
            fi
          done
          echo "‚úÖ All Loki credentials are present."

          # Install jq if missing
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update && sudo apt-get install -y jq
          fi

          # Test Loki connectivity
          TS=$(date +%s%N)
          PROBE=$(jq -n --arg ts "$TS" '{"streams":[{"stream":{"job":"ci-probe"},"values":[[$ts,"probe"]]}]}')
          RESP_CODE=$(curl -s -o /tmp/probe.txt -w "%{http_code}" \
            -u "${LOKI_USER}:${LOKI_TOKEN}" \
            -H "Content-Type: application/json" \
            -X POST "${LOKI_URL}" \
            --data-raw "${PROBE}")

          echo "üîç Loki probe response code: ${RESP_CODE}"
          if [[ "${RESP_CODE}" -lt 200 || "${RESP_CODE}" -ge 300 ]]; then
            echo "‚ùå Loki probe failed. Response:"
            cat /tmp/probe.txt
            exit 1
          fi
          echo "‚úÖ Loki probe successful."

          # ---------------- Extract Allure Metrics ----------------
          if [ ! -f "allure-report/widgets/summary.json" ]; then
            echo "‚ö†Ô∏è No allure-report/widgets/summary.json found, skipping push."
            exit 0
          fi

          echo "üìä Parsing Allure summary..."
          PASSED=$(jq -r '.statistic.passed  // 0' allure-report/widgets/summary.json)
          FAILED=$(jq -r '.statistic.failed  // 0' allure-report/widgets/summary.json)
          BROKEN=$(jq -r '.statistic.broken  // 0' allure-report/widgets/summary.json)
          SKIPPED=$(jq -r '.statistic.skipped // 0' allure-report/widgets/summary.json)
          UNKNOWN=$(jq -r '.statistic.unknown // 0' allure-report/widgets/summary.json)
          TOTAL=$(jq -r '.statistic.total // 0' allure-report/widgets/summary.json)
          DURATION_MS=$(jq -r '.time.duration // 0' allure-report/widgets/summary.json)

          PASS_RATE=$(awk "BEGIN { if ($TOTAL>0) print ($PASSED*100.0/$TOTAL); else print 0 }")

          echo "‚úÖ Test metrics parsed:"
          echo "   Total=$TOTAL, Passed=$PASSED, Failed=$FAILED, Skipped=$SKIPPED, Broken=$BROKEN, Duration=${DURATION_MS}ms, PassRate=${PASS_RATE}%"

          # ---------------- Build Loki Payload ----------------
          REPO="${{ github.repository }}"
          BRANCH="${{ github.ref_name }}"
          RUN_ID="${{ github.run_id }}"
          SHA="${{ github.sha }}"
          WORKFLOW="${{ github.workflow }}"
          TS_NANO=$(date +%s%N)

          LOG=$(jq -n \
            --arg repo "$REPO" \
            --arg project "$PROJECT_NAME" \
            --arg env "$ENV" \
            --arg branch "$BRANCH" \
            --arg run_id "$RUN_ID" \
            --arg sha "$SHA" \
            --arg workflow "$WORKFLOW" \
            --argjson passed $PASSED \
            --argjson failed $FAILED \
            --argjson broken $BROKEN \
            --argjson skipped $SKIPPED \
            --argjson total $TOTAL \
            --argjson duration_ms $DURATION_MS \
            --argjson pass_rate $PASS_RATE \
            '{
              repo: $repo, project: $project, env: $env, branch: $branch,
              run_id: $run_id, sha: $sha, workflow: $workflow,
              passed: $passed, failed: $failed, broken: $broken,
              skipped: $skipped, total: $total, duration_ms: $duration_ms,
              pass_rate: $pass_rate
            }')

          PAYLOAD=$(jq -n \
            --arg ts "$TS_NANO" \
            --argjson log "$LOG" \
            --arg project "$PROJECT_NAME" \
            --arg env "$ENV" \
            --arg repo "$REPO" \
            --arg branch "$BRANCH" \
            '{
              streams: [
                {
                  stream: { job: "ci-tests", project: $project, env: $env, repo: $repo, branch: $branch },
                  values: [[ $ts, ($log | tostring) ]]
                }
              ]
            }')

          # ---------------- Push to Grafana Loki ----------------
          echo "üöÄ Pushing metrics to Grafana Loki..."
          STATUS=$(curl -s -o /tmp/loki_resp.txt -w "%{http_code}" \
            -u "${LOKI_USER}:${LOKI_TOKEN}" \
            -H "Content-Type: application/json" \
            -X POST "${LOKI_URL}" \
            --data-raw "${PAYLOAD}")

          echo "Loki push status: ${STATUS}"
          cat /tmp/loki_resp.txt || true

          if [[ "${STATUS}" -ge 200 && "${STATUS}" -lt 300 ]]; then
            echo "‚úÖ Metrics successfully pushed to Grafana Loki."
          else
            echo "‚ùå Failed to push metrics."
            exit 1
          fi
