name: Selenium-Cucumber Tests + Allure + Grafana Loki

on:
  workflow_dispatch:
  repository_dispatch:
    types: [run-tests]

jobs:
  selenium-tests:
    name: Selenium + Cucumber + Allure + Loki
    runs-on: ubuntu-latest

    env:
      PROJECT_NAME: Selenium-Cucumber-Tests
      JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64
      CHROME_BIN: /usr/bin/chromium-browser

      # ðŸ”¹ Grafana Loki Cloud Config
      GRAFANA_LOKI_URL: https://logs-prod-ap-southeast-1.grafana.net/loki/api/v1/push
      GRAFANA_LOKI_TOKEN: ${{ secrets.GRAFANA_LOKI_TOKEN }}  # cicd-loki-writer token with logs:write scope

    steps:
      # -----------------------------
      # Setup and Dependencies
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install Chrome & Chromedriver
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser chromium-chromedriver jq
          echo "Chrome version: $(chromium-browser --version)"
          echo "Chromedriver version: $(chromedriver --version)"

      - name: Cache Maven packages
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      # -----------------------------
      # Run Selenium Cucumber Tests
      # -----------------------------
      - name: Run Selenium + Cucumber Tests
        id: run-tests
        run: |
          echo "ðŸš€ Running Selenium-Cucumber tests..."
          START_TIME=$(date +%s)
          mvn clean test || true   # Continue even if tests fail so logs still push
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))

          # Extract metrics from Surefire XML reports
          TOTAL=$(grep "<testsuite" target/surefire-reports/*.xml | grep -o 'tests="[0-9]*"' | awk -F'"' '{s+=$2} END{print s}')
          FAILURES=$(grep "<testsuite" target/surefire-reports/*.xml | grep -o 'failures="[0-9]*"' | awk -F'"' '{f+=$2} END{print f}')
          PASSED=$((TOTAL - FAILURES))

          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILURES" >> $GITHUB_OUTPUT

      # -----------------------------
      # Generate Allure Report
      # -----------------------------
      - name: Generate Allure Report
        run: |
          npm install -g allure-commandline
          allure generate target/allure-results --clean -o allure-report

      - name: Upload Allure Report as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report

      # -----------------------------
      # Push Logs and Metrics to Grafana Loki
      # -----------------------------
      - name: Push logs and metrics to Grafana Loki
        run: |
          echo "ðŸ›°ï¸ Preparing logs and metrics for Grafana Loki..."
          mkdir -p logs

          # Capture test logs (fallback if missing)
          if [ -d "target/surefire-reports" ] && [ "$(ls -A target/surefire-reports)" ]; then
            cat target/surefire-reports/*.txt > logs/execution.log
          else
            echo "No test logs found, using default message." > logs/execution.log
          fi

          echo "ðŸ”§ Formatting logs for Loki..."
          # Convert each log line into a proper Loki entry
          VALUES=$(awk '{ print "[\""strftime("%s%N")"\", \""$0"\"]" }' logs/execution.log | paste -sd "," -)
          LOG_JSON="{\"streams\": [{\"stream\": {\"job\": \"$PROJECT_NAME\", \"source\": \"GitHubActions\", \"level\": \"info\", \"total\": \"${{ steps.run-tests.outputs.total }}\", \"passed\": \"${{ steps.run-tests.outputs.passed }}\", \"failed\": \"${{ steps.run-tests.outputs.failed }}\", \"duration_seconds\": \"${{ steps.run-tests.outputs.duration }}\"}, \"values\": [$VALUES]}]}"

          echo "$LOG_JSON" > loki-log.json
          echo "ðŸ“„ Payload size: $(wc -c < loki-log.json) bytes"

          echo "ðŸ”— Pushing logs to ${GRAFANA_LOKI_URL} ..."
          RESPONSE=$(curl -v \
            -H "Authorization: Bearer ${GRAFANA_LOKI_TOKEN}" \
            -H "Content-Type: application/json" \
            -X POST "${GRAFANA_LOKI_URL}" \
            --data-binary "@loki-log.json" \
            -o /tmp/loki_resp.txt -w "%{http_code}")

          echo "HTTP Response Code: $RESPONSE"
          echo "Response Body:"
          cat /tmp/loki_resp.txt

          if [[ "$RESPONSE" != "204" ]]; then
            echo "âŒ Failed to send logs to Loki."
            exit 1
          else
            echo "âœ… Logs successfully sent to Grafana Loki!"
          fi

      # -----------------------------
      # Workflow Summary
      # -----------------------------
      - name: Workflow Summary
        if: always()
        run: |
          echo "âœ… Selenium-Cucumber workflow finished"
          echo "ðŸ§¾ Check artifacts for the Allure report"
          echo "ðŸ“¡ Check Grafana Loki dashboard for logs and metrics"
