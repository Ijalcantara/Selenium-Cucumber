name: Run Selenium-Cucumber tests and push logs to Grafana Loki

on:
  repository_dispatch:
    types: [run-tests]
  workflow_dispatch:

jobs:
  tests:
    runs-on: ubuntu-latest
    name: Run Tests and Send Logs to Grafana Loki

    env:
      PROJECT_NAME: Selenium-Cucumber-Tests
      HEADLESS: "true"

    steps:
      # üß© Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # ‚òï Setup Java for Maven
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      # üåê Install Chrome
      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1

      # üì¶ Install Allure CLI
      - name: Install Allure CLI
        run: npm install -g allure-commandline@2

      # üß™ Run tests (continue even on failure)
      - name: Run Maven tests
        env:
          BASE_URL: "https://github.com/Ijalcantara/Selenium-Cucumber"
        run: |
          set +e
          mvn -B clean test -DbaseUrl="${BASE_URL}" -Dheadless="${HEADLESS}"
          echo "MAVEN_EXIT_CODE=$?" >> $GITHUB_ENV

      # üì§ Upload raw reports even if failed
      - name: Upload test reports
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: target/surefire-reports

      # üìä Generate Allure report
      - name: Generate Allure HTML
        if: ${{ always() }}
        run: |
          allure generate target/allure-results --clean -o allure-report || echo "No allure results found."

      # üì§ Upload Allure report
      - name: Upload Allure HTML
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report

      # üîó Push logs to Grafana Loki
      - name: Push logs to Grafana Loki
        if: ${{ always() }}
        env:
          PROJECT_NAME: Selenium-Cucumber-Tests
          LOKI_URL: ${{ secrets.GRAFANA_LOKI_URL }}
          LOKI_USER: ${{ secrets.GRAFANA_LOKI_USER }}
          LOKI_TOKEN: ${{ secrets.GRAFANA_LOKI_TOKEN }}
        run: |
          echo "üõ∞Ô∏è Preparing log payload..."
          mkdir -p logs

          if [ -d "target/surefire-reports" ] && [ "$(ls -A target/surefire-reports)" ]; then
            cat target/surefire-reports/*.txt > logs/execution.log
          else
            echo "No test logs found, using default message." > logs/execution.log
          fi

          # Escape newlines and quotes for Loki JSON
          LOG_CONTENT=$(jq -Rn --arg job "$PROJECT_NAME" --arg content "$(sed 's/"/\\"/g; s/$/\\n/' logs/execution.log | tr -d '\n')" \
            '{streams:[{stream:{job:$job,source:"GitHubActions"},values:[[ (now|floor|tostring)+"000000000", $content ]]}]}')

          echo "$LOG_CONTENT" > loki-log.json

          echo "üîó Sending logs to Grafana Loki..."
          RESPONSE=$(curl -s -o /tmp/loki_resp.txt -w "%{http_code}" \
            -u "$LOKI_USER:$LOKI_TOKEN" \
            -H "Content-Type: application/json" \
            -X POST "$LOKI_URL" \
            --data-binary "@loki-log.json")

          echo "HTTP Response Code: $RESPONSE"
          cat /tmp/loki_resp.txt || echo "(empty)"

          if [[ "$RESPONSE" == "204" ]]; then
            echo "‚úÖ Logs successfully sent to Grafana Loki!"
          else
            echo "‚ùå Failed to send logs. (HTTP $RESPONSE)"
            exit 0  # Don't fail workflow if Loki fails
