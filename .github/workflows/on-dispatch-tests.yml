name: Run Selenium-Cucumber tests and push logs to Grafana Loki (Enhanced)

on:
  repository_dispatch:
    types: [run-tests]
  workflow_dispatch:

jobs:
  tests:
    runs-on: ubuntu-latest
    name: Run Tests and Send Logs to Grafana Loki

    env:
      PROJECT_NAME: Selenium-Cucumber-Tests
      HEADLESS: "true"
      ENVIRONMENT: "staging"

    steps:
      # ðŸ§© Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # â˜• Setup Java 17
      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      # ðŸ§° Install dependencies
      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y unzip wget jq google-chrome-stable
          curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
          sudo apt-get install -y nodejs
          npm install -g allure-commandline http-server

      # ðŸ§ª Run Selenium-Cucumber Tests
      - name: Run Cucumber Tests
        id: run_tests
        run: |
          echo "Running Cucumber tests for environment: $ENVIRONMENT"
          START=$(date +%s)
          mvn clean test -Dheadless=$HEADLESS -Denv=$ENVIRONMENT
          END=$(date +%s)
          DURATION=$((END - START))
          echo "duration_seconds=$DURATION" >> $GITHUB_ENV

      # ðŸ“Š Generate Allure Report
      - name: Generate Allure Reports
        run: |
          allure generate target/allure-results --clean -o allure-report || true
          allure generate target/allure-results --single-file --clean -o allure-report-single || true

      # ðŸ“¦ Upload test artifacts
      - name: Upload Test Reports
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            target/surefire-reports
            target/cucumber-reports
            allure-report
            allure-report-single
            target/allure-results

      # ðŸ”Ž Validate Loki secrets
      - name: Validate Grafana Loki configuration
        run: |
          if [ -z "${{ secrets.GRAFANA_LOKI_URL }}" ] || [ -z "${{ secrets.GRAFANA_LOKI_TOKEN }}" ]; then
            echo "âŒ Missing required secrets: GRAFANA_LOKI_URL or GRAFANA_LOKI_TOKEN"
            exit 1
          fi

      # ðŸ” Parse Allure Summary
      - name: Parse Allure Summary
        id: allure_summary
        run: |
          SUMMARY_FILE="allure-report/widgets/summary.json"
          if [ -f "$SUMMARY_FILE" ]; then
            TOTAL=$(jq '.statistic.total' "$SUMMARY_FILE")
            PASSED=$(jq '.statistic.passed' "$SUMMARY_FILE")
            FAILED=$(jq '.statistic.failed' "$SUMMARY_FILE")
            BROKEN=$(jq '.statistic.broken' "$SUMMARY_FILE")
            SKIPPED=$(jq '.statistic.skipped' "$SUMMARY_FILE")
            UNKNOWN=$(jq '.statistic.unknown' "$SUMMARY_FILE")
          else
            echo "âš ï¸ No summary.json found. Defaulting to zeros."
            TOTAL=0; PASSED=0; FAILED=0; BROKEN=0; SKIPPED=0; UNKNOWN=0;
          fi

          if [ "$TOTAL" -gt 0 ]; then
            PASS_RATE=$(echo "scale=2; $PASSED * 100 / $TOTAL" | bc)
          else
            PASS_RATE=0
          fi

          echo "TOTAL=$TOTAL" >> $GITHUB_ENV
          echo "PASSED=$PASSED" >> $GITHUB_ENV
          echo "FAILED=$FAILED" >> $GITHUB_ENV
          echo "BROKEN=$BROKEN" >> $GITHUB_ENV
          echo "SKIPPED=$SKIPPED" >> $GITHUB_ENV
          echo "UNKNOWN=$UNKNOWN" >> $GITHUB_ENV
          echo "PASS_RATE=$PASS_RATE" >> $GITHUB_ENV

      # ðŸ§© Validate Grafana Loki connectivity
      - name: Test Grafana Loki Connection
        run: |
          echo "Testing connectivity to Grafana Loki..."
          PROBE_PAYLOAD='{"streams": [{"stream": {"probe":"connectivity_test"}, "values": [["'"$(($(date +%s%N)))"'","connection test"]]}]}'
          RESPONSE=$(curl -s -w "%{http_code}" -o /tmp/resp.txt -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.GRAFANA_LOKI_TOKEN }}" \
            -d "$PROBE_PAYLOAD" \
            "${{ secrets.GRAFANA_LOKI_URL }}/loki/api/v1/push")
          STATUS=$(tail -n1 <<< "$RESPONSE")
          if [ "$STATUS" != "204" ]; then
            echo "âš ï¸ Connection to Grafana Loki failed with status: $STATUS"
            echo "Response: $(cat /tmp/resp.txt)"
            exit 1
          fi
          echo "âœ… Loki connectivity verified."

      # ðŸ“¤ Push test results to Grafana Loki
      - name: Push Test Results to Grafana Loki
        run: |
          TIMESTAMP=$(($(date +%s%N)))

          LOG_MESSAGE=$(printf "%s\n" \
            "Project: $PROJECT_NAME" \
            "Environment: $ENVIRONMENT" \
            "Passed: $PASSED" \
            "Failed: $FAILED" \
            "Broken: $BROKEN" \
            "Skipped: $SKIPPED" \
            "Total: $TOTAL" \
            "Pass Rate: ${PASS_RATE}%" \
            "Duration: ${duration_seconds}s" \
            "Run ID: $GITHUB_RUN_ID" \
            "Branch: $GITHUB_REF_NAME" \
            "Repo: $GITHUB_REPOSITORY")

          PAYLOAD=$(jq -n \
            --arg msg "$LOG_MESSAGE" \
            --arg time "$TIMESTAMP" \
            --arg project "$PROJECT_NAME" \
            --arg env "$ENVIRONMENT" \
            '{
              streams: [{
                stream: {
                  project: $project,
                  job: "selenium_cucumber_tests",
                  env: $env,
                  source: "github_actions"
                },
                values: [[ $time, $msg ]]
              }]
            }')

          echo "Sending logs to Grafana Loki..."
          RESPONSE=$(curl -s -w "%{http_code}" -o /tmp/loki_resp.txt -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.GRAFANA_LOKI_TOKEN }}" \
            -d "$PAYLOAD" \
            "${{ secrets.GRAFANA_LOKI_URL }}/loki/api/v1/push")

          STATUS=$(tail -n1 <<< "$RESPONSE")

          if [ "$STATUS" == "204" ]; then
            echo "âœ… Logs successfully sent to Grafana Loki."
          else
            echo "âŒ Failed to push logs. Status: $STATUS"
            echo "Response: $(cat /tmp/loki_resp.txt)"
            exit 1
          fi
