name: Run Selenium-Cucumber tests and push logs to Grafana Loki

on:
  repository_dispatch:
    types: [run-tests]
  workflow_dispatch:

jobs:
  tests:
    runs-on: ubuntu-latest
    name: Run Tests and Send Logs to Grafana Loki

    env:
      PROJECT_NAME: Selenium-Cucumber-Tests
      HEADLESS: "true"

    steps:
      # üß© Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # ‚òï Setup Java for Maven
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      # üåê Install Chrome
      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1

      # üì¶ Install Allure CLI
      - name: Install Allure CLI
        run: npm install -g allure-commandline@2

      # üß™ Run tests (continue even on failure)
      - name: Run Maven tests
        env:
          BASE_URL: "https://github.com/Ijalcantara/Selenium-Cucumber"
        run: |
          set +e
          START_TIME=$(date +%s)
          mvn -B clean test -DbaseUrl="${BASE_URL}" -Dheadless="${HEADLESS}"
          TEST_EXIT_CODE=$?
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))

          echo "TEST_EXIT_CODE=$TEST_EXIT_CODE" >> $GITHUB_ENV
          echo "TEST_DURATION=$DURATION" >> $GITHUB_ENV
          echo "MAVEN_EXIT_CODE=$TEST_EXIT_CODE" >> $GITHUB_ENV

      # üì§ Upload raw reports
      - name: Upload test reports
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: target/surefire-reports

      # üìä Generate Allure report
      - name: Generate Allure HTML
        if: ${{ always() }}
        run: |
          allure generate target/allure-results --clean -o allure-report || echo "No allure results found."

      # üì§ Upload Allure report
      - name: Upload Allure HTML
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report

      # üîó Push logs + metrics to Grafana Loki
      - name: Push logs and metrics to Grafana Loki
        if: ${{ always() }}
        env:
          PROJECT_NAME: Selenium-Cucumber-Tests
          LOKI_URL: ${{ secrets.GRAFANA_LOKI_URL }}
          LOKI_USER: ${{ secrets.GRAFANA_LOKI_USER }}
          LOKI_TOKEN: ${{ secrets.GRAFANA_LOKI_TOKEN }}
          TEST_DURATION: ${{ env.TEST_DURATION }}
          TEST_EXIT_CODE: ${{ env.TEST_EXIT_CODE }}
        run: |
          echo "üõ∞Ô∏è Preparing log payload..."
          mkdir -p logs

          # Extract summary metrics from surefire reports
          PASSES=$(grep -oP 'Failures: 0, Errors: 0' target/surefire-reports/*.txt | wc -l || echo 0)
          FAILURES=$(grep -oP 'Failures: [1-9]\d*' target/surefire-reports/*.txt | wc -l || echo 0)
          TOTAL=$((PASSES + FAILURES))
          PASS_RATE=0
          if [ "$TOTAL" -gt 0 ]; then
            PASS_RATE=$((100 * PASSES / TOTAL))
          fi

          # Create JSON metrics log
          echo "{\"tests_run\":$TOTAL,\"failures\":$FAILURES,\"passed\":$PASSES,\"pass_rate\":$PASS_RATE,\"duration_seconds\":$TEST_DURATION}" > logs/metrics.json

          # Combine raw execution logs
          if [ -d "target/surefire-reports" ] && [ "$(ls -A target/surefire-reports)" ]; then
            cat target/surefire-reports/*.txt > logs/execution.log
          else
            echo "No test logs found, using default message." > logs/execution.log
          fi

          # Prepare Loki JSON payload with metrics + execution streams
          LOG_CONTENT=$(jq -n \
            --slurpfile metrics logs/metrics.json \
            --arg raw "$(sed 's/"/\\"/g' logs/execution.log | tr '\n' ' ')" \
            --arg job "$PROJECT_NAME" \
            '{
              streams: [
                { stream: { job: $job, source: "GitHubActions", type: "metrics" },
                  values: [[ (now|floor|tostring)+"000000000", ($metrics[0]|@json) ]] },
                { stream: { job: $job, source: "GitHubActions", type: "execution" },
                  values: [[ (now|floor|tostring)+"000000000", $raw ]] }
              ]
            }'
          )

          echo "$LOG_CONTENT" > loki-log.json

          # Push to Grafana Loki
          echo "üîó Sending logs and metrics to Grafana Loki..."
          RESPONSE=$(curl -s -o /tmp/loki_resp.txt -w "%{http_code}" \
            -u "$LOKI_USER:$LOKI_TOKEN" \
            -H 'Content-Type: application/json' \
            -X POST "$LOKI_URL" \
            --data-binary "@loki-log.json")

          echo "HTTP Response Code: $RESPONSE"
          cat /tmp/loki_resp.txt || echo "(empty)"

          if [[ "$RESPONSE" == "204" ]]; then
            echo "‚úÖ Logs and metrics successfully sent to Grafana Loki!"
          else
            echo "‚ùå Failed to send logs. (HTTP $RESPONSE)"
          fi
