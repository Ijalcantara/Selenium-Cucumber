name: Run Selenium-Cucumber Tests with Grafana Loki (v11)

on:
  repository_dispatch:
    types: [ run-tests ]
  workflow_dispatch:

jobs:
  tests:
    name: Selenium Cucumber + Allure tests
    runs-on: ubuntu-latest

    env:
      PROJECT_NAME: selenium-cucumber
      ENV: ${{ github.event.client_payload.env || vars.ENV || 'staging' }}
      HEADLESS: "true"

    steps:
      # ---------------- Checkout & Setup ----------------
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1

      - name: Set up Node.js (for Allure CLI)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Allure CLI
        run: npm install -g allure-commandline@2

      # ---------------- Run Tests ----------------
      - name: Run Selenium Cucumber Tests
        env:
          HEADLESS: ${{ env.HEADLESS }}
        run: |
          echo "Starting tests using HEADLESS=${HEADLESS}"
          mvn -B clean test -Dheadless="${HEADLESS}"

      # ---------------- Upload Reports ----------------
      - name: Upload raw reports (Cucumber/Surefire/Allure)
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            **/target/surefire-reports/**
            **/target/cucumber-reports/**
            **/target/allure-results/**

      - name: Generate Allure HTML Report
        if: ${{ always() }}
        run: |
          allure generate target/allure-results --clean -o allure-report
          echo "‚úÖ Allure HTML report generated."

      - name: Upload Allure HTML folder
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: allure-html
          path: allure-report

      - name: Generate single-file Allure report
        if: ${{ always() }}
        run: allure generate target/allure-results --single-file --clean -o target/allure-single

      - name: Upload Allure single-file report
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: allure-single-file
          path: target/allure-single

      # ---------------- Push to Grafana Loki ----------------
      - name: Push Test Metrics to Grafana Loki
        if: ${{ always() }}
        env:
          LOKI_URL: ${{ secrets.GRAFANA_LOKI_URL }}
          LOKI_USER: ${{ secrets.GRAFANA_LOKI_USER }}
          LOKI_TOKEN: ${{ secrets.GRAFANA_LOKI_TOKEN }}
          PROJECT_NAME: ${{ env.PROJECT_NAME }}
          ENV: ${{ env.ENV }}
        shell: bash
        run: |
          set -euo pipefail

          echo "üîç Validating Grafana Loki credentials..."
          for v in LOKI_URL LOKI_USER LOKI_TOKEN; do
            if [ -z "${!v:-}" ]; then echo "‚ùå Missing env: $v"; exit 1; fi
          done
          echo "‚úÖ Loki credentials present."

          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update && sudo apt-get install -y jq
          fi

          # Test connectivity
          TS=$(date +%s%N)
          PROBE=$(jq -n --arg ts "$TS" '{"streams":[{"stream":{"job":"ci-probe"},"values":[[$ts,"probe"]]}]}')
          code=$(curl -s -o /tmp/probe.txt -w "%{http_code}" \
            -u "${LOKI_USER}:${LOKI_TOKEN}" \
            -H "Content-Type: application/json" \
            -X POST "${LOKI_URL}" \
            --data-raw "${PROBE}")

          echo "Probe response: ${code}"
          if [[ "${code}" -lt 200 || "${code}" -ge 300 ]]; then
            echo "‚ùå Probe failed"; cat /tmp/probe.txt; exit 1;
          fi
          echo "‚úÖ Loki probe OK."

          # ---------------- Parse metrics ----------------
          PASSED=0; FAILED=0; BROKEN=0; SKIPPED=0; UNKNOWN=0; TOTAL=0; DURATION_MS=0;

          if [ -f "allure-report/widgets/summary.json" ]; then
            echo "üìä Parsing allure-report/widgets/summary.json"
            PASSED=$(jq -r '.statistic.passed  // 0' allure-report/widgets/summary.json)
            FAILED=$(jq -r '.statistic.failed  // 0' allure-report/widgets/summary.json)
            BROKEN=$(jq -r '.statistic.broken  // 0' allure-report/widgets/summary.json)
            SKIPPED=$(jq -r '.statistic.skipped // 0' allure-report/widgets/summary.json)
            UNKNOWN=$(jq -r '.statistic.unknown // 0' allure-report/widgets/summary.json)
            TOTAL=$(jq -r '.statistic.total // ((.statistic.passed // 0) + (.statistic.failed // 0) + (.statistic.broken // 0) + (.statistic.skipped // 0) + (.statistic.unknown // 0))' allure-report/widgets/summary.json)
            DURATION_MS=$(jq -r '.time.duration // 0' allure-report/widgets/summary.json)
          else
            echo "‚ö†Ô∏è No Allure summary found. Skipping push."; exit 0;
          fi

          echo "‚úÖ Metrics: total=$TOTAL passed=$PASSED failed=$FAILED broken=$BROKEN skipped=$SKIPPED duration=$DURATION_MS ms"

          # ---------------- Build and push payload ----------------
          TS_ISO=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          REPO="${{ github.repository }}"
          RUN_ID="${{ github.run_id }}"
          RUN_NUMBER="${{ github.run_number }}"
          SHA="${{ github.sha }}"
          BRANCH="${{ github.ref_name }}"
          WORKFLOW="${{ github.workflow }}"
          JOB="${{ github.job }}"

          LOG=$(jq -n \
            --arg ts "$TS_ISO" \
            --arg repo "$REPO" \
            --arg project "$PROJECT_NAME" \
            --arg env "$ENV" \
            --arg workflow "$WORKFLOW" \
            --arg job "$JOB" \
            --arg sha "$SHA" \
            --arg branch "$BRANCH" \
            --arg run_id "$RUN_ID" \
            --arg run_number "$RUN_NUMBER" \
            --argjson passed $PASSED \
            --argjson failed $FAILED \
            --argjson broken $BROKEN \
            --argjson skipped $SKIPPED \
            --argjson total $TOTAL \
            --argjson duration_ms $DURATION_MS \
            '{
              ts: $ts, repo: $repo, project: $project, env: $env,
              workflow: $workflow, job: $job, sha: $sha, branch: $branch,
              run_id: $run_id, run_number: $run_number,
              passed: $passed, failed: $failed, broken: $broken,
              skipped: $skipped, total: $total, duration_ms: $duration_ms,
              pass_rate: (if $total > 0 then (($passed * 100.0)/$total) else 0 end)
            }')

          PAYLOAD=$(jq -n \
            --arg ts "$(date +%s%N)" \
            --arg line "$(echo "$LOG" | jq -c '.')" \
            --arg project "$PROJECT_NAME" \
            --arg env "$ENV" \
            --arg repo "$REPO" \
            --arg branch "$BRANCH" \
            '{
              streams: [
                {
                  stream: { job: "ci-tests", project: $project, env: $env, repo: $repo, branch: $branch },
                  values: [[ $ts, $line ]]
                }
              ]
            }')

          RESP=$(curl -s -o /tmp/loki_resp.txt -w "%{http_code}" \
            -u "${LOKI_USER}:${LOKI_TOKEN}" \
            -H "Content-Type: application/json" \
            -X POST "${LOKI_URL}" \
            --data-raw "${PAYLOAD}")

          echo "Loki response: ${RESP}"
          cat /tmp/loki_resp.txt || true

          if [[ "${RESP}" -ge 200 && "${RESP}" -lt 300 ]]; then
            echo "‚úÖ Metrics pushed to Grafana Loki"
          else
            echo "‚ùå Failed to push metrics"; exit 1;
          fi
