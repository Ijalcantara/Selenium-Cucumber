name: ðŸš€ Push Selenium Logs to Grafana Loki

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  push-logs:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“‚ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ§° Prepare log content
        id: prepare
        run: |
          echo "ðŸ›°ï¸ Preparing logs and metrics for Grafana Loki..."
          echo "ðŸ”§ Collecting test logs..."
          # Example test logs - replace with your real log path or test output
          echo "INFO: Selenium test started" > logs.txt
          echo "PASS: Login test passed" >> logs.txt
          echo "FAIL: Checkout test failed" >> logs.txt
          
          echo "âœ… Log file created:"
          cat logs.txt

      - name: ðŸ§¾ Format logs as JSON payload
        id: format
        run: |
          echo "ðŸ”§ Formatting logs for Loki..."
          LOG_CONTENT=$(jq -Rs . < logs.txt)
          TIMESTAMP=$(date +%s%N)
          
          cat <<EOF > payload.json
          {
            "streams": [
              {
                "stream": {
                  "job": "Selenium-Cucumber-Tests",
                  "source": "github-actions",
                  "branch": "${GITHUB_REF_NAME}",
                  "repository": "${GITHUB_REPOSITORY}"
                },
                "values": [
                  ["$TIMESTAMP", $LOG_CONTENT]
                ]
              }
            ]
          }
          EOF

          echo "ðŸ“„ Payload size: $(wc -c < payload.json) bytes"
          jq . payload.json

      - name: ðŸ“¡ Push logs to Grafana Loki
        env:
          LOKI_URL: "https://logs-prod-ap-southeast-1.grafana.net/loki/api/v1/push"
          LOKI_USER: "${{ secrets.GRAFANA_USER }}"
          LOKI_API_KEY: "${{ secrets.GRAFANA_API_KEY }}"
        run: |
          echo "ðŸ”— Pushing logs to $LOKI_URL ..."
          RESPONSE=$(curl -s -w "\n%{http_code}" -u "$LOKI_USER:$LOKI_API_KEY" \
            -H "Content-Type: application/json" \
            -d @payload.json \
            "$LOKI_URL")

          BODY=$(echo "$RESPONSE" | head -n 1)
          CODE=$(echo "$RESPONSE" | tail -n 1)

          echo "HTTP Response Code: $CODE"
          echo "Response Body: $BODY"

          if [ "$CODE" != "204" ]; then
            echo "âŒ Failed to send logs to Loki."
            exit 1
          else
            echo "âœ… Logs successfully sent to Grafana Loki!"
          fi
