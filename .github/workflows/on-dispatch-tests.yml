name: CI-CD Pipeline with Grafana Loki

on:
  push:
    branches: [ main ]
  pull_request:

env:
  PROJECT_NAME: Selenium-Cucumber-Tests
  GRAFANA_LOKI_URL: https://logs-prod-ap-southeast-1.grafana.net/loki/api/v1/push
  # Token stored in GitHub secrets (from your Grafana Cloud Service Account)
  GRAFANA_LOKI_TOKEN: ${{ secrets.GRAFANA_LOKI_TOKEN }}

jobs:
  test-and-log:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Run Selenium Cucumber tests
        run: |
          echo "üöÄ Running Selenium Cucumber tests..."
          mvn clean test || true   # Continue even if tests fail so logs still push

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Push logs and metrics to Grafana Loki (Debug)
        run: |
          echo "üõ∞Ô∏è Preparing logs and metrics for Grafana Loki..."
          mkdir -p logs

          # Capture raw test logs
          if [ -d "target/surefire-reports" ] && [ "$(ls -A target/surefire-reports)" ]; then
            cat target/surefire-reports/*.txt > logs/execution.log
          else
            echo "No test logs found, using default message." > logs/execution.log
          fi

          # Create Loki payload (JSON structure)
          LOG_CONTENT=$(jq -n \
            --arg job "$PROJECT_NAME" \
            --arg content "$(cat logs/execution.log)" \
            --arg total "0" \
            --arg passed "0" \
            --arg failed "0" \
            --arg duration "30" \
            '{streams:[{stream:{job:$job, level:"info", source:"GitHubActions", total:$total, passed:$passed, failed:$failed, duration_seconds:$duration}, values:[[ (now|floor|tostring)+"000000000", $content ]]}]}')

          echo "$LOG_CONTENT" > loki-log.json

          echo "üîó Pushing logs to ${GRAFANA_LOKI_URL} ..."
          RESPONSE=$(curl -v \
            -H "Authorization: Bearer ${GRAFANA_LOKI_TOKEN}" \
            -H "Content-Type: application/json" \
            -X POST "${GRAFANA_LOKI_URL}" \
            --data-binary "@loki-log.json" \
            -o /tmp/loki_resp.txt -w "%{http_code}")

          echo "HTTP Response Code: $RESPONSE"
          echo "Response Body:"
          cat /tmp/loki_resp.txt

          if [[ "$RESPONSE" != "204" ]]; then
            echo "‚ùå Failed to send logs to Loki."
            exit 1
          else
            echo "‚úÖ Logs successfully sent to Grafana Loki!"
          fi
