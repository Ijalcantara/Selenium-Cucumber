name: Run Selenium-Cucumber Tests + Push Logs to Grafana Loki

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    env:
      PROJECT_NAME: Selenium-Cucumber-Tests

    steps:
      - name: üßæ Checkout repository
        uses: actions/checkout@v4

      - name: ‚òï Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: üöÄ Run Maven Tests
        run: mvn clean test

      - name: üìä Prepare Log Payload
        if: always()
        run: |
          echo "üõ∞Ô∏è Preparing logs for Grafana Loki..."

          mkdir -p logs
          if [ -d "target/surefire-reports" ]; then
            cat target/surefire-reports/*.txt > logs/execution.log
          else
            echo "No test logs found" > logs/execution.log
          fi

          LOG_CONTENT=$(jq -Rn --arg job "$PROJECT_NAME" --arg content "$(cat logs/execution.log)" \
            '{streams:[{stream:{job:$job,level:"info",source:"GitHubActions"},values:[[ (now|floor|tostring)+"000000000", $content ]]}]}')
          
          echo "$LOG_CONTENT" > loki-log.json
          cat loki-log.json

      - name: üì° Push Logs to Grafana Loki
        if: always()
        env:
          LOKI_URL: ${{ secrets.GRAFANA_LOKI_URL }}
          LOKI_USER: ${{ secrets.GRAFANA_LOKI_USER }}
          LOKI_TOKEN: ${{ secrets.GRAFANA_LOKI_TOKEN }}
        run: |
          echo "üîó Sending logs to $LOKI_URL ..."
          RESPONSE=$(curl -s -o /tmp/loki_resp.txt -w "%{http_code}" \
            -u "${LOKI_USER}:${LOKI_TOKEN}" \
            -H "Content-Type: application/json" \
            -X POST "${LOKI_URL}" \
            --data-binary "@loki-log.json")

          echo "HTTP Response Code: $RESPONSE"
          cat /tmp/loki_resp.txt || echo "(empty)"

          if [[ "$RESPONSE" == "204" ]]; then
            echo "‚úÖ Logs successfully sent to Grafana Loki!"
          else
            echo "‚ùå Failed to send logs. (HTTP $RESPONSE)"
            exit 1
          fi
