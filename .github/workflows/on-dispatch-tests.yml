name: Run Selenium-Cucumber tests and push logs to Grafana Loki

on:
  repository_dispatch:
    types: [run-tests]
  workflow_dispatch:

jobs:
  tests:
    runs-on: ubuntu-latest
    name: Run Tests and Send Logs to Grafana Loki

    env:
      PROJECT_NAME: Selenium-Cucumber-Tests
      HEADLESS: "true"

    steps:
      # ðŸ§© Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # â˜• Setup Java 17 for Maven
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      # ðŸŒ Install Chrome
      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1

      # ðŸ“¦ Install Chrome dependencies (Linux)
      - name: Install Chrome dependencies
        run: sudo apt-get update && sudo apt-get install -y libnss3 libgconf-2-4 fonts-liberation

      # ðŸ“¦ Install Allure CLI
      - name: Install Allure CLI
        run: npm install -g allure-commandline@2

      # ðŸ§ª Run Maven tests (continue even if failures occur)
      - name: Run Maven tests
        env:
          BASE_URL: "https://jmiguelcheq.github.io/calculator-demo"
        run: |
          set +e
          mvn -B clean test -DbaseUrl="${BASE_URL}" -Dheadless="${HEADLESS}"
          echo "MAVEN_EXIT_CODE=$?" >> $GITHUB_ENV

      # ðŸ’€ Fail workflow if tests failed (optional)
      - name: Fail if tests failed
        if: ${{ always() }}
        run: exit $MAVEN_EXIT_CODE

      # ðŸ“¤ Upload raw test reports even if failed
      - name: Upload surefire reports
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: target/surefire-reports

      # ðŸ“Š Generate Allure HTML report
      - name: Generate Allure HTML
        if: ${{ always() }}
        run: |
          allure generate target/allure-results --clean -o allure-report || echo "No allure results found."

      # ðŸ“¤ Upload Allure report
      - name: Upload Allure HTML
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report

      # ðŸ”— Push logs to Grafana Loki
      - name: Push logs to Grafana Loki
        if: ${{ always() }}
        env:
          LOKI_URL: ${{ secrets.GRAFANA_LOKI_URL }}
          LOKI_USER: ${{ secrets.GRAFANA_LOKI_USER }}
          LOKI_TOKEN: ${{ secrets.GRAFANA_LOKI_TOKEN }}
        run: |
          echo "ðŸ›°ï¸ Preparing log payload..."
          mkdir -p logs

          # Combine test logs
          if [ -d "target/surefire-reports" ] && [ "$(ls -A target/surefire-reports)" ]; then
            cat target/surefire-reports/*.txt > logs/execution.log
          else
            echo "No test logs found, using default message." > logs/execution.log
          fi

          # Include Maven exit code in logs
          echo "MAVEN_EXIT_CODE=$MAVEN_EXIT_CODE" >> logs/execution.log

          # Build Loki JSON payload
          LOG_CONTENT=$(jq -Rn --arg job "${PROJECT_NAME}" --arg content "$(cat logs/execution.log)" \
            '{streams:[{stream:{job:$job,source:"GitHubActions"},values:[[ (now|floor|tostring)+"000000000", $content ]]}]}')

          echo "$LOG_CONTENT" > loki-log.json

          # Optional: upload Loki payload for debugging
          gh actions upload-artifact --name loki-payload --path loki-log.json || echo "GitHub CLI not available, skipping artifact upload"

          # Send logs to Grafana Loki
          echo "ðŸ”— Sending logs to Grafana Loki..."
          RESPONSE=$(curl -s -o /tmp/loki_resp.txt -w "%{http_code}" \
            -u "${LOKI_USER}:${LOKI_TOKEN}" \
            -H "Content-Type: application/json" \
            -X POST "${LOKI_URL}" \
            --data-binary "@loki-log.json")

          echo "HTTP Response Code: $RESPONSE"
          cat /tmp/loki_resp.txt || echo "(empty)"

          if [[ "$RESPONSE" == "204" ]]; then
            echo "âœ… Logs successfully sent to Grafana Loki!"
          else
            echo "âŒ Failed to send logs. (HTTP $RESPONSE)" >&2
          fi
